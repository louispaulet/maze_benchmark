<!DOCTYPE html>
<html>
<head>
  <title>Agar.io Clone with Improvements</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.10.0/p5.min.js"></script>
</head>
<body>
<script>
let player;
let foods = [];
let enemies = [];
const TOTAL_FOOD = 100;
const TOTAL_ENEMIES = 5; // Reduced to 5 enemies
let gameOver = false;
let keys = {}; // To track pressed keys

function setup() {
  createCanvas(windowWidth, windowHeight);
  player = new Cell(0, 0, 20, color(0, 255, 0));

  // Generate food cells
  for (let i = 0; i < TOTAL_FOOD; i++) {
    let x = random(-width * 2, width * 2);
    let y = random(-height * 2, height * 2);
    foods.push(new Cell(x, y, 5, color(255, 0, 0)));
  }

  // Generate enemy cells
  for (let i = 0; i < TOTAL_ENEMIES; i++) {
    let x = random(-width * 2, width * 2);
    let y = random(-height * 2, height * 2);
    let r = random(15, 40);
    enemies.push(new EnemyCell(x, y, r, color(0, 0, 255)));
  }
}

function draw() {
  if (gameOver) {
    background(0);
    fill(255);
    textSize(64);
    textAlign(CENTER, CENTER);
    text('Game Over', width / 2, height / 2);
    return;
  }

  background(200);

  // Update player velocity based on currently pressed keys
  updatePlayerVelocity();

  // Translate the canvas to center the player
  translate(width / 2 - player.pos.x, height / 2 - player.pos.y);

  // Update and display food cells
  for (let i = foods.length - 1; i >= 0; i--) {
    foods[i].show();
    if (player.eats(foods[i])) {
      // Increase player's size
      let sumArea = PI * player.r * player.r + PI * foods[i].r * foods[i].r;
      player.r = sqrt(sumArea / PI);

      foods.splice(i, 1);
      // Add a new food cell
      let x = player.pos.x + random(-width, width);
      let y = player.pos.y + random(-height, height);
      foods.push(new Cell(x, y, 5, color(255, 0, 0)));
    }
  }

  // Update and display enemy cells
  for (let i = enemies.length - 1; i >= 0; i--) {
    enemies[i].move(player);
    enemies[i].update();
    enemies[i].show();

    if (player.eats(enemies[i])) {
      if (player.r > enemies[i].r * 1.1) {
        // Player eats the enemy
        let sumArea = PI * player.r * player.r + PI * enemies[i].r * enemies[i].r;
        player.r = sqrt(sumArea / PI);

        enemies.splice(i, 1);
      } else if (player.r < enemies[i].r * 0.9) {
        // Player is eaten by the enemy
        gameOver = true;
      }
    }
  }

  // Update and display the player cell
  player.update();
  player.show();
}

function keyPressed() {
  keys[keyCode] = true;
}

function keyReleased() {
  keys[keyCode] = false;
}

function updatePlayerVelocity() {
  let vx = 0;
  let vy = 0;
  if (keys[LEFT_ARROW]) vx -= 3;
  if (keys[RIGHT_ARROW]) vx += 3;
  if (keys[UP_ARROW]) vy -= 3;
  if (keys[DOWN_ARROW]) vy += 3;
  player.setVelocity(vx, vy);
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}

class Cell {
  constructor(x, y, r, col) {
    this.pos = createVector(x, y);
    this.r = r;
    this.color = col;
    this.vel = createVector(0, 0);
  }

  update() {
    this.pos.add(this.vel);
  }

  show() {
    fill(this.color);
    noStroke();
    ellipse(this.pos.x, this.pos.y, this.r * 2, this.r * 2);
  }

  setVelocity(x, y) {
    this.vel = createVector(x, y);
  }

  eats(other) {
    let d = p5.Vector.dist(this.pos, other.pos);
    if (d < this.r + other.r) {
      return true;
    } else {
      return false;
    }
  }
}

class EnemyCell extends Cell {
  constructor(x, y, r, col) {
    super(x, y, r, col);
  }

  move(player) {
    let direction = p5.Vector.sub(player.pos, this.pos);
    direction.normalize();

    if (this.r > player.r * 1.1) {
      // Enemy is bigger, chase the player
      this.vel = direction.copy().mult(1.5);
    } else if (this.r < player.r * 0.9) {
      // Enemy is smaller, run away from the player
      this.vel = direction.copy().mult(-1.5);
    } else {
      // Similar size, move randomly
      if (frameCount % 60 === 0) {
        // Change direction every second
        this.vel = p5.Vector.random2D().mult(1);
      }
    }
  }
}
</script>
</body>
</html>
